<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>å‡ºè­¦ç³»ç»Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#d32f2f">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    body { font-family: Arial; margin: 0; padding: 10px; }
    h2 { margin-top: 0; }
    input, select, textarea, button {
      width: 100%; padding: 10px; margin: 6px 0;
    }
    #map { height: 300px; margin-top: 10px; }
    .card { border: 1px solid #ccc; padding: 10px; margin-top: 10px; }
  </style>
</head>
<body>

<h2>ğŸš¨ å‡ºè­¦ç³»ç»Ÿ</h2>

<div class="card">
  <select id="type">
    <option value="MVA">äº¤é€šäº‹æ•… MVA</option>
    <option value="ç«ç¾">ç«ç¾</option>
    <option value="æ‰è›‡">æ‰è›‡</option>
    <option value="å…¶ä»–">å…¶ä»–</option>
  </select>

  <input id="vehicle" placeholder="ğŸš’ è½¦è¾†ç¼–å· / è½¦ç‰Œ">
  <input id="leader" placeholder="ğŸ‘¨â€ğŸš’ è½¦é•¿å§“å">
  <textarea id="members" placeholder="ğŸ‘¥ é˜Ÿå‘˜ï¼ˆé€—å·åˆ†éš”ï¼‰"></textarea>
  <textarea id="note" placeholder="ğŸ“ ç°åœºæƒ…å†µå¤‡æ³¨"></textarea>

  <button id="btnLocate">ğŸ“ è·å–å½“å‰ä½ç½®</button>
  <button id="btnMission">ğŸš¨ æ–°å‡ºè­¦</button>
</div>

<div id="map"></div>
<div id="list"></div>

<!-- Libraries -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/********************
 * Firebase é…ç½®
 ********************/
const firebaseConfig = {
  apiKey: "AIzaSyALQICqeblHAcxsrZDWskl3qXqjeLon-gQ",
  authDomain: "klm-01-31490.firebaseapp.com",
  databaseURL: "https://klm-01-31490-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "klm-01-31490",
  storageBucket: "klm-01-31490.appspot.com",
  messagingSenderId: "xxxx",
  appId: "xxxx"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/********************
 * åœ°å›¾åˆå§‹åŒ–
 ********************/
let map = L.map('map').setView([5.364, 100.561], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

let userMarker = null;
let currentPos = null;
let markers = {};

/********************
 * å®šä½ï¼ˆç”¨æˆ·ç‚¹å‡»ï¼‰
 ********************/
function requestLocation() {
  navigator.geolocation.getCurrentPosition(
    pos => {
      currentPos = pos.coords;
      const latlng = [pos.coords.latitude, pos.coords.longitude];
      map.setView(latlng, 16);

      if (userMarker) userMarker.setLatLng(latlng);
      else userMarker = L.marker(latlng).addTo(map).bindPopup("ä½ çš„ä½ç½®").openPopup();
    },
    err => alert("å®šä½å¤±è´¥ï¼Œè¯·å¼€å¯ GPS å¹¶å…è®¸æƒé™"),
    { enableHighAccuracy: true, timeout: 15000 }
  );
}

/********************
 * æ–°å‡ºè­¦
 ********************/
function createMission() {
  if (!currentPos) return alert("è¯·å…ˆè·å–å½“å‰ä½ç½®");

  const now = Date.now();

  const data = {
    type: type.value,
    vehicle: vehicle.value,
    leader: leader.value,
    members: members.value,
    note: note.value,
    lat: currentPos.latitude,
    lng: currentPos.longitude,
    time: new Date().toLocaleString(),
    startTime: now,
    endTime: null,
    status: "å‡ºè­¦ä¸­"
  };

  db.ref("missions").push(data);
}

/********************
 * å®Œæˆå‡ºè­¦
 ********************/
function finishMission(id) {
  db.ref("missions/" + id).update({
    status: "å·²å®Œæˆ",
    endTime: Date.now()
  });
}

/********************
 * æ—¶é—´è®¡ç®—
 ********************/
function calcDuration(start, end) {
  const s = Math.floor((end - start) / 1000);
  return `${Math.floor(s / 60)}åˆ†${s % 60}ç§’`;
}

/********************
 * æŠ¥å‘Šç”Ÿæˆï¼ˆæ–‡å­— + PDFï¼‰
 ********************/
function generatePDF(id) {
  db.ref("missions/" + id).once("value").then(snap => {
    const m = snap.val();
    if (!m) return;

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    let y = 15;
    const line = t => { doc.text(t, 10, y); y += 8; };

    line("å‡ºè­¦æŠ¥å‘Š");
    line("-------------------");
    line(`ç±»å‹ï¼š${m.type}`);
    line(`æ—¶é—´ï¼š${m.time}`);
    line(`åœ°ç‚¹ï¼š${m.lat}, ${m.lng}`);
    line("");
    line(`è½¦è¾†ï¼š${m.vehicle}`);
    line(`è½¦é•¿ï¼š${m.leader}`);
    line(`é˜Ÿå‘˜ï¼š${m.members}`);
    line(`çŠ¶æ€ï¼š${m.status}`);
    line(`æ—¶é•¿ï¼š${calcDuration(m.startTime, m.endTime)}`);
    line("");
    line("ç°åœºæƒ…å†µï¼š");
    doc.text(m.note || "-", 10, y, { maxWidth: 180 });

    doc.save("å‡ºè­¦æŠ¥å‘Š.pdf");
  });
}

/********************
 * ç›‘å¬ä»»åŠ¡
 ********************/
db.ref("missions").on("value", snap => {
  list.innerHTML = "";
  const data = snap.val() || {};

  Object.entries(data).forEach(([id, m]) => {
    const icon = L.icon({
      iconUrl: m.status === "å‡ºè­¦ä¸­"
        ? "https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png"
        : "https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png",
      iconSize: [32, 32], iconAnchor: [16, 32]
    });

    if (!markers[id]) {
      markers[id] = L.marker([m.lat, m.lng], { icon }).addTo(map)
        .bindPopup(`${m.type}<br>${m.status}`);
    }

    list.innerHTML += `
      <div class="card">
        <b>${m.type}</b><br>
        è½¦è¾†ï¼š${m.vehicle}<br>
        è½¦é•¿ï¼š${m.leader}<br>
        çŠ¶æ€ï¼š${m.status}<br>
        ${m.status === "å‡ºè­¦ä¸­"
          ? `<button onclick="finishMission('${id}')">å®Œæˆ</button>`
          : `<button onclick="generatePDF('${id}')">PDF</button>`}
      </div>`;
  });
});

btnLocate.onclick = requestLocation;
btnMission.onclick = createMission;

// PWA
if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
</script>

</body>
</html>